<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>safe-math-ts browser compat</title>
  </head>
  <body>
    <pre id="result">runningâ€¦</pre>
    <script type="module">
      import {
        add,
        addVec3,
        crossVec3,
        delta3,
        div,
        dotVec3,
        frame,
        lengthVec3,
        mat4FromRigidTransform,
        mul,
        normalizeVec3,
        point3,
        quat,
        quatIdentity,
        quantity,
        rotateVec3ByQuat,
        scale,
        sqrt,
        sub,
        subVec3,
        transformPoint3,
        unit,
        valueOf,
      } from '/npm/esm/mod.js';

      const assertAlmost = (actual, expected, message, eps = 1e-9) => {
        if (Math.abs(actual - expected) > eps) {
          throw new Error(`${message}: expected ${expected}, got ${actual}`);
        }
      };

      const assertEqual = (actual, expected, message) => {
        if (actual !== expected) {
          throw new Error(`${message}: expected ${expected}, got ${actual}`);
        }
      };

      try {
        const m = unit('m');
        const s = unit('s');

        assertEqual(valueOf(add(quantity(m, 6), quantity(m, 4))), 10, 'add');
        assertEqual(valueOf(sub(quantity(m, 6), quantity(m, 4))), 2, 'sub');
        assertEqual(valueOf(scale(quantity(m, 6), 3)), 18, 'scale');
        assertAlmost(valueOf(div(quantity(m, 9), quantity(s, 3))), 3, 'div');
        assertEqual(valueOf(mul(quantity(m, 3), quantity(m, 4))), 12, 'mul');
        assertAlmost(valueOf(sqrt(mul(quantity(m, 4), quantity(m, 4)))), 4, 'sqrt');

        const world = frame('world');

        const dx = delta3(world, quantity(m, 3), quantity(m, 0), quantity(m, 0));
        const dy = delta3(world, quantity(m, 0), quantity(m, 4), quantity(m, 0));
        assertAlmost(valueOf(lengthVec3(addVec3(dx, dy))), 5, 'Pythagorean length');
        assertAlmost(valueOf(lengthVec3(subVec3(dy, dy))), 0, 'zero subVec3');

        const xhat = normalizeVec3(dx);
        assertAlmost(xhat[0], 1, 'normalize x');
        assertAlmost(xhat[1], 0, 'normalize y');
        assertAlmost(xhat[2], 0, 'normalize z');

        const xu = delta3(world, quantity(m, 1), quantity(m, 0), quantity(m, 0));
        const yu = delta3(world, quantity(m, 0), quantity(m, 1), quantity(m, 0));
        assertAlmost(valueOf(dotVec3(xu, yu)), 0, 'orthogonal dot');

        const cross = crossVec3(xu, yu);
        assertAlmost(cross[0], 0, 'cross x');
        assertAlmost(cross[1], 0, 'cross y');
        assertAlmost(cross[2], 1, 'cross z');

        const q_id = quatIdentity(world);
        const v = delta3(world, quantity(m, 1), quantity(m, 2), quantity(m, 3));
        const rotated = rotateVec3ByQuat(q_id, v);
        assertAlmost(rotated[0], 1, 'quat identity x');
        assertAlmost(rotated[1], 2, 'quat identity y');
        assertAlmost(rotated[2], 3, 'quat identity z');

        const sin45 = Math.sin(Math.PI / 4);
        const cos45 = Math.cos(Math.PI / 4);
        const q_90z = quat(world, world, 0, 0, sin45, cos45);
        const rotated_x = rotateVec3ByQuat(q_90z, xu);
        assertAlmost(rotated_x[0], 0, 'rot90z x');
        assertAlmost(rotated_x[1], 1, 'rot90z y');
        assertAlmost(rotated_x[2], 0, 'rot90z z');

        const cam = frame('cam');
        const q_id2 = quat(cam, world, 0, 0, 0, 1);
        const t = delta3(cam, quantity(m, 1), quantity(m, 2), quantity(m, 3));
        const mat = mat4FromRigidTransform(cam, world, q_id2, t);
        const p = point3(world, quantity(m, 0), quantity(m, 0), quantity(m, 0));
        const p_cam = transformPoint3(mat, p);
        assertAlmost(p_cam[0], 1, 'transform x');
        assertAlmost(p_cam[1], 2, 'transform y');
        assertAlmost(p_cam[2], 3, 'transform z');

        document.getElementById('result').textContent = 'PASS';
      } catch (e) {
        document.getElementById('result').textContent = 'FAIL: ' + e.message;
      }
    </script>
  </body>
</html>
