name: Runtime Compatibility

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions: {}

jobs:
  # Build the npm package once and share it across jobs that need it (browser only).
  build-npm:
    name: Build npm package
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: write # upload-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: denoland/setup-deno@v2.0.3
        with:
          deno-version: '2.7.1'
      - name: Build npm package
        run: deno task npm:build
      - name: Upload npm artifact
        uses: actions/upload-artifact@v7.0.0
        with:
          name: npm-build
          path: npm/

  # Bun: full test suite via Deno.test shim (imports TypeScript directly).
  compat-bun:
    name: Compat — Bun
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: oven-sh/setup-bun@v2
      - name: Run Bun compat test
        run: bun test --preload ./tests/compat/bun-deno-shim.ts ./tests/*.test.ts ./examples/*.test.ts

  # Node.js: full test suite via Deno.test shim (Node 24 strips TypeScript natively).
  compat-node:
    name: Compat — Node.js
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '24'
      - name: Run Node.js compat test
        run: node --import ./tests/compat/node-deno-shim.mjs --test ./tests/*.test.ts ./examples/*.test.ts

  # Cloudflare Workers: full test suite via Deno.test shim inside workerd.
  compat-cloudflare:
    name: Compat — Cloudflare Workers
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - name: Install compat tooling
        run: cd tests/compat && npm install
      - name: Run Cloudflare Workers compat test
        run: cd tests/compat/cloudflare && npx vitest run

  # Browser: Playwright serves the project root and runs the ESM smoke test in Chromium.
  compat-browser:
    name: Compat — Browser (Chromium)
    needs: build-npm
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: read # download-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - name: Download npm build
        uses: actions/download-artifact@v4
        with:
          name: npm-build
          path: npm/
      - name: Install compat tooling
        run: cd tests/compat && npm install
      - name: Install Playwright browsers
        run: cd tests/compat && npx playwright install chromium --with-deps
      - name: Run browser compat test
        run: cd tests/compat/browser && npx playwright test
