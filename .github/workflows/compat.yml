name: Runtime Compatibility

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions: {}

jobs:
  # Build the npm package once (compiles tests + runs Node tests via dnt) and
  # share the artifact with all downstream jobs.
  build-npm:
    name: Build npm package
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: write # upload-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: denoland/setup-deno@v2.0.3
        with:
          deno-version: '2.7.1'
      - name: Build npm package (compiles + runs Node tests)
        run: deno task npm:build
      - name: Upload npm artifact
        uses: actions/upload-artifact@v7.0.0
        with:
          name: npm-build
          path: npm/

  # Bun: compiled npm tests via dnt's test_runner (Bun supports CJS natively).
  compat-bun:
    name: Compat — Bun
    needs: build-npm
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: read # download-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - uses: oven-sh/setup-bun@v2
      - name: Download npm build
        uses: actions/download-artifact@v4
        with:
          name: npm-build
          path: npm/
      - name: Install npm deps
        run: cd npm && npm install
      - name: Run Bun compat test
        run: cd npm && bun run ./test_runner.cjs

  # Node.js: compiled npm tests (also ran during build-npm via dnt, re-run here
  # for explicit visibility in CI).
  compat-node:
    name: Compat — Node.js
    needs: build-npm
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: read # download-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - name: Download npm build
        uses: actions/download-artifact@v4
        with:
          name: npm-build
          path: npm/
      - name: Install npm deps
        run: cd npm && npm install
      - name: Run Node.js compat test
        run: cd npm && node test_runner.cjs

  # Cloudflare Workers: compiled npm tests inside workerd via vitest pool.
  compat-cloudflare:
    name: Compat — Cloudflare Workers
    needs: build-npm
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: read # download-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - name: Download npm build
        uses: actions/download-artifact@v4
        with:
          name: npm-build
          path: npm/
      - name: Install npm deps
        run: cd npm && npm install
      - name: Run Cloudflare Workers compat test
        run: cd npm && npx vitest run -c vitest.cloudflare.config.ts

  # Browser: compiled npm tests inside Chromium via @vitest/browser + Playwright.
  compat-browser:
    name: Compat — Browser (Chromium)
    needs: build-npm
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      actions: read # download-artifact
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
      - name: Download npm build
        uses: actions/download-artifact@v4
        with:
          name: npm-build
          path: npm/
      - name: Install npm deps
        run: cd npm && npm install
      - name: Install Playwright browsers
        run: cd npm && npx playwright install chromium --with-deps
      - name: Run browser compat test
        run: cd npm && npx vitest run -c vitest.browser.config.ts
